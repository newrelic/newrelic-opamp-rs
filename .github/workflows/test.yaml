name: test
on:
  push:
permissions:
  contents: read
# See https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
jobs:
  basic-tests:
    runs-on: ubuntu-latest
    name: test
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          submodules: true
      - name: Install stable
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # master
        with:
          toolchain: stable
      - name: cargo generate-lockfile
        if: hashFiles('Cargo.lock') == ''
        run: cargo generate-lockfile
      - name: cargo test --locked
        run: cargo test --locked --all-features --all-targets
      - name: cargo test --doc
        run: cargo test --locked --all-features --doc

  cargo-fmt:
    runs-on: ubuntu-latest
    name: Format test / stable
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # master
        with:
          toolchain: stable
          components: rustfmt
      - run: cargo fmt --check

  cargo-clippy:
    runs-on: ubuntu-latest
    name: clippy / ${{ matrix.toolchain }}
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # master
        with:
          toolchain: stable
          components: clippy
      - run: cargo clippy -- -D clippy::all

  security:
    uses: ./.github/workflows/component_security.yml
    secrets:
      slack_webhook: ${{ secrets.AC_SLACK_WEBHOOK }}

  third-party-notices-check:
    name: ‚öñÔ∏è Third party licenses
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: newrelic/rust-licenses-noticer@v1
        with:
          template-file: THIRD_PARTY_NOTICES.md.tmpl

  check-all-green:
    name: üü¢ All required checks and tests pass
    if: always()

    needs:
      - basic-tests
      - cargo-clippy
      - cargo-fmt
      - security
      - third-party-notices-check

    runs-on: Ubuntu-latest

    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # release/v1
      with:
        jobs: ${{ toJSON(needs) }}
